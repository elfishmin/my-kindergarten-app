import streamlit as st
import pandas as pd
from datetime import datetime
import requests
import json
import time

# ==========================================
# 1. 核心設定 (強制永久顯示側邊欄與介面優化)
# ==========================================
# 請確保此 URL 與您的 Google Apps Script 部署網址一致
SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxrOI14onlrt4TAEafHX1MfY60rN-dXHJ5RF2Ipx4iB6pp1A8lPPpE8evMNemg5tygtyQ/exec"

st.set_page_config(
    page_title="才藝班點名系統", 
    page_icon="🏫", 
    layout="wide", 
    initial_sidebar_state="expanded" 
)

# 注入 CSS：強制側邊欄永遠顯示，隱藏收合按鈕，調整點名區字體與間距
st.markdown("""
    <style>
        /* 隱藏左上角預設的收合/展開箭頭 */
        [data-testid="collapsedControl"] {
            display: none !important;
        }

        /* 強制側邊欄在手機窄螢幕下不收合，保持顯示 */
        @media (max-width: 991px) {
            section[data-testid="stSidebar"] {
                width: 250px !important;
                position: relative !important;
                margin-left: 0 !important;
            }
            .main {
                margin-left: 10px !important;
            }
        }

        /* 調整 Radio 單選框的間隙 */
        .stRadio [role=radiogroup] {
            gap: 15px;
        }
    </style>
""", unsafe_allow_html=True)

# ==========================================
# 2. 名單資料 (240+ 筆交叉比對名單)
# ==========================================
all_data = {
    "星期一": {
        "舞蹈A": [("冰淇淋", "吳姷樼"), ("冰淇淋", "宋宥希"), ("冰淇淋", "張簡睿泱"), ("彩虹魚", "周子芹"), ("雪碧", "陳禹妃"), ("雪碧", "劉苡璇"), ("雪碧", "龔畇溱"), ("綠格子", "邱子芮")],
        "感統A": [("可樂1班", "林文峖"), ("可樂1班", "胡恩瑞"), ("可樂1班", "許甯喬"), ("可樂1班", "蔡宇謙"), ("可樂2班", "王品崴"), ("可樂2班", "蔡崴羽"), ("冰淇淋", "徐承睿"), ("冰淇淋", "陳芸希"), ("雪碧", "游帛洵")]
    },
    "星期二": {
        "美術": [("冰淇淋", "宋宥希"), ("冰淇淋", "林思橙"), ("粉蠟筆", "王銘緯"), ("粉蠟筆", "許鈞凱"), ("粉蠟筆", "陳愷蒂"), ("粉蠟筆", "謝恩典"), ("粉蠟筆", "許竑榤"), ("彩虹魚", "吳愷杰"), ("彩虹魚", "黃語葳"), ("雪碧", "王星鈞"), ("雪碧", "林佳穎"), ("雪碧", "陳禹妃"), ("雪碧", "黃梓碩"), ("雪碧", "廖允菲"), ("藍天使", "吳秉宸"), ("綠格子", "王子蕎"), ("紫葡萄", "張簡瑞晨")],
        "陶土": [("冰淇淋", "徐承睿"), ("彩虹魚", "李恩瑨"), ("彩虹魚", "周子芹"), ("雪碧", "林佳穎"), ("雪碧", "游帛洵"), ("雪碧", "龔畇溱"), ("粉蠟筆", "謝恩典"), ("藍天使", "鄭尹棠")],
        "美語小班": [("可樂1班", "林文峖"), ("可樂1班", "胡恩瑞"), ("可樂2班", "王品崴"), ("可樂2班", "黃若芸")]
    },
    "星期三": {
        "桌遊": [("冰淇淋", "徐承睿"), ("冰淇淋", "陳芸希"), ("彩虹魚", "李恩瑨"), ("彩虹魚", "陳盺"), ("雪碧", "王星鈞"), ("雪碧", "許宥甯"), ("粉蠟筆", "吳鎧崴"), ("粉蠟筆", "鐘苡禎"), ("綠格子", "陳語棠"), ("紫葡萄", "吳尚恩"), ("紫葡萄", "黃芊熒"), ("紫葡萄", "蘇祐森")],
        "足球": [("冰淇淋", "宋宥希"), ("彩虹魚", "周冠賢"), ("彩虹魚", "戴子睿"), ("粉蠟筆", "謝恩典"), ("藍天使", "吳秉宸"), ("藍天使", "黃彥淇"), ("綠格子", "周睿澤"), ("綠格子", "陳冠呈"), ("紫葡萄", "何丞鎧"), ("紫葡萄", "蘇祐森")]
    },
    "星期四": {
        "感統B": [("可樂1班", "宋昱希"), ("可樂1班", "黃柏睿"), ("可樂2班", "黃若芸"), ("可樂2班", "黃婕恩"), ("冰淇淋", "范芯瑀"), ("冰淇淋", "張簡睿泱"), ("彩虹魚", "戴子睿"), ("雪碧", "陳芋菲"), ("雪碧", "曾語安")],
        "直排輪": [("冰淇淋", "吳承浚"), ("冰淇淋", "吳姷樼"), ("冰淇淋", "宋宥希"), ("冰淇淋", "范芯瑀"), ("彩虹魚", "徐郁蓁"), ("粉蠟筆", "陳愷蒂"), ("粉蠟筆", "劉恩谷"), ("粉蠟筆", "鐘苡禎"), ("藍天使", "周星宇"), ("綠格子", "張哲銘"), ("紫葡萄", "吳尚恩"), ("紫葡萄", "林予煖")]
    },
    "星期五": {
        "積木A": [("冰淇淋", "宋宥希"), ("冰淇淋", "范芯瑀"), ("冰淇淋", "張簡睿泱"), ("冰淇淋", "陳芸希"), ("雪碧", "吳哲睿"), ("雪碧", "游帛洵"), ("雪碧", "黃梓碩"), ("藍天使", "黃宇頡"), ("蘋果派", "蔡枍廷"), ("甜甜圈", "林芊妤")],
        "積木B": [("冰淇淋", "林思橙"), ("冰淇淋", "徐承睿"), ("綠格子", "陳冠呈"), ("綠格子", "陳姵吟")],
        "美語小班": [("可樂1班", "林文峖"), ("可樂1班", "胡恩瑞"), ("可樂2班", "王品崴"), ("可樂2班", "黃若芸")]
    }
}

# --- 3. 狀態管理 ---
today_dt = datetime.now()
today_str = today_dt.strftime("%Y-%m-%d")
weekday_map = {0: "星期一", 1: "星期二", 2: "星期三", 3: "星期四", 4: "星期五",
