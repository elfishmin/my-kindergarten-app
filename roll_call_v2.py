import streamlit as st
import pandas as pd
from datetime import datetime
import requests
import json

# ==========================================
# 1. åŸºæœ¬è¨­å®š (å·²è¨˜ä½æ‚¨çš„ URL)
# ==========================================
SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxrOI14onlrt4TAEafHX1MfY60rN-dXHJ5RF2Ipx4iB6pp1A8lPPpE8evMNemg5tygtyQ/exec"
st.set_page_config(page_title="æ‰è—ç­æ™ºæ…§é»å", page_icon="ğŸ«", layout="wide")

# 2. å®šç¾© 2025 èª²è¡¨åˆ†çµ„
# æ˜ŸæœŸä¸€
mon_classes = ["è¶³çƒ", "ç›´æ’è¼ª", "ç©æœ¨B", "æ¡ŒéŠ", "é™¶åœŸ", "ç¾èªAä¸€", "ç¾èªAä¸‰", "ç¾èªBäºŒ", "ç¾èªBå››"]
# æ˜ŸæœŸäºŒ
tue_classes = ["ç¾è¡“"]
# æš«æ™‚æœªæ’å…¥åå–®ä½†å­˜åœ¨çš„ (å¦‚ç©æœ¨A, èˆè¹ˆA, æ„Ÿçµ±A/B) å…ˆæ­¸é¡åˆ°å…¶ä»–
other_classes = ["ç©æœ¨A", "èˆè¹ˆA", "æ„Ÿçµ±A", "æ„Ÿçµ±B"]

# å®Œæ•´åå–®è³‡æ–™ (raw_data ä¿æŒä¸è®Šï¼Œæ­¤è™•çœç•¥ä»¥ç¯€çœç©ºé–“)
raw_data = {
    "ç¾è¡“": [("å¤§ä¸€ç­ ç²‰è Ÿç­†", "ç‹éŠ˜ç·¯"), ("å¤§ä¸€ç­ ç²‰è Ÿç­†", "è¨±éˆå‡±"), ("å¤§ä¸€ç­ ç²‰è Ÿç­†", "é™³æ„·è’‚"), ("å¤§ä¸€ç­ è—å¤©ä½¿", "å³ç§‰å®¸"), ("å¤§äºŒç­ ç´«è‘¡è„", "å¼µç°¡ç‘æ™¨"), ("å¤§äºŒç­ ç¶ æ ¼å­", "ç‹å­è•"), ("ä¸­äºŒç­ å†°æ·‡æ·‹", "å®‹å®¥å¸Œ")],
    "æ¡ŒéŠ": [("å¤§ä¸€ç­ ç²‰è Ÿç­†", "å³é§å´´"), ("å¤§ä¸€ç­ ç²‰è Ÿç­†", "é˜è‹¡ç¦"), ("å¤§äºŒç­ ç´«è‘¡è„", "é»ƒèŠŠç†’"), ("å¤§äºŒç­ ç´«è‘¡è„", "è˜‡ç¥æ£®"), ("å¤§äºŒç­ ç¶ æ ¼å­", "é™³èªæ£ "), ("ä¸­äºŒç­ å†°æ·‡æ·‹", "å¾æ‰¿ç¿")],
    "é™¶åœŸ": [("å¤§ä¸€ç­ ç²‰è Ÿç­†", "è¬æ©å…¸"), ("å¤§ä¸€ç­ è—å¤©ä½¿", "é„­å°¹æ£ "), ("ä¸­äºŒç­ å†°æ·‡æ·‹", "å¾æ‰¿ç¿")],
    "è¶³çƒ": [("å¤§ä¸€ç­ ç²‰è Ÿç­†", "è¬æ©å…¸"), ("å¤§ä¸€ç­ è—å¤©ä½¿", "å³ç§‰å®¸"), ("å¤§ä¸€ç­ è—å¤©ä½¿", "é»ƒå½¥æ·‡"), ("ä¸­äºŒç­ å†°æ·‡æ·‹", "å®‹å®¥å¸Œ")],
    "ç›´æ’è¼ª": [("å¤§ä¸€ç­ ç²‰è Ÿç­†", "é™³æ„·è’‚"), ("å¤§ä¸€ç­ ç²‰è Ÿç­†", "åŠ‰æ©è°·"), ("å¤§ä¸€ç­ è—å¤©ä½¿", "å‘¨æ˜Ÿå®‡"), ("å¤§äºŒç­ ç´«è‘¡è„", "å³å°šæ©"), ("å¤§äºŒç­ ç´«è‘¡è„", "æ—äºˆç…–"), ("å¤§äºŒç­ ç¶ æ ¼å­", "å¼µå“²éŠ˜"), ("ä¸­äºŒç­ å†°æ·‡æ·‹", "å³æ‰¿æµš"), ("ä¸­äºŒç­ å†°æ·‡æ·‹", "å®‹å®¥å¸Œ")],
    "ç©æœ¨A": [("å¤§ä¸€ç­ è—å¤©ä½¿", "é»ƒå®‡é ¡"), ("ä¸­äºŒç­ å†°æ·‡æ·‹", "å®‹å®¥å¸Œ"), ("ä¸­äºŒç­ å†°æ·‡æ·‹", "å¼µç°¡ç¿æ³±")],
    "ç©æœ¨B": [("å¤§äºŒç­ ç¶ æ ¼å­", "é™³å† å‘ˆ"), ("å¤§äºŒç­ ç¶ æ ¼å­", "é™³å§µåŸ"), ("ä¸­äºŒç­ å†°æ·‡æ·‹", "å¾æ‰¿ç¿")],
    "èˆè¹ˆA": [("å¤§äºŒç­ ç¶ æ ¼å­", "é‚±å­èŠ®"), ("ä¸­äºŒç­ å†°æ·‡æ·‹", "å³å§·æ¨¼"), ("ä¸­äºŒç­ å†°æ·‡æ·‹", "å®‹å®¥å¸Œ"), ("ä¸­äºŒç­ å†°æ·‡æ·‹", "å¼µç°¡ç¿æ³±")],
    "ç¾èªAä¸€": [("ä¸­äºŒç­ å†°æ·‡æ·‹", "å³æ‰¿æµš"), ("ä¸­äºŒç­ å†°æ·‡æ·‹", "ææ‚…å®¸"), ("ä¸­äºŒç­ å†°æ·‡æ·‹", "é™³åŠ­é½Š")],
    "ç¾èªAä¸‰": [("ä¸­äºŒç­ å†°æ·‡æ·‹", "å³æ‰¿æµš"), ("ä¸­äºŒç­ å†°æ·‡æ·‹", "ææ‚…å®¸"), ("ä¸­äºŒç­ å†°æ·‡æ·‹", "é™³åŠ­é½Š")],
    "æ„Ÿçµ±A": [("ä¸­äºŒç­ å†°æ·‡æ·‹", "å¾æ‰¿ç¿"), ("ä¸­äºŒç­ å†°æ·‡æ·‹", "é™³èŠ¸å¸Œ")],
    "æ„Ÿçµ±B": [("ä¸­äºŒç­ å†°æ·‡æ·‹", "èŒƒèŠ¯ç‘€"), ("ä¸­äºŒç­ å†°æ·‡æ·‹", "å¼µç°¡ç¿æ³±")],
    "ç¾èªBå››": [("å¤§äºŒç­ ç¶ æ ¼å­", "è”¡æå»·")]
}

# --- 3. ç²å–ä»Šå¤©æ˜ŸæœŸå¹¾èˆ‡ç‹€æ…‹ ---
today_dt = datetime.now()
today_str = today_dt.strftime("%Y-%m-%d")
weekday = today_dt.weekday() # 0=Mon, 1=Tue...

if 'done_list' not in st.session_state:
    st.session_state.done_list = []

def sync_data():
    try:
        r = requests.get(f"{SCRIPT_URL}?date={today_str}", timeout=10)
        if r.status_code == 200:
            st.session_state.done_list = r.json()
    except: pass

# --- 4. å´é‚Šæ¬„ï¼šæŒ‰æ˜ŸæœŸæ’åº ---
with st.sidebar:
    st.title("ğŸ—“ï¸ èª²ç¨‹æ’ç¨‹")
    if st.button("ğŸ”„ åˆ·æ–°é€²åº¦", use_container_width=True):
        sync_data()
    
    # å»ºç«‹æ’åºæ¸…å–®
    sections = [
        ("æ˜ŸæœŸä¸€ Mon", mon_classes, 0),
        ("æ˜ŸæœŸäºŒ Tue", tue_classes, 1),
        ("å…¶ä»–èª²ç¨‹", other_classes, -1)
    ]
    
    all_display_options = []
    mapping = {}
    
    for title, c_list, w_idx in sections:
        header = f"ğŸ”¹ {title}"
        if weekday == w_idx:
            header += " (ğŸ“Œ ä»Šæ—¥)"
        st.markdown(f"**{header}**")
        
        for c in c_list:
            if c in raw_data:
                icon = "âœ…" if c in st.session_state.done_list else "âšª"
                label = f"{icon} {c}"
                # ä½¿ç”¨ button æˆ– radio
                if st.sidebar.button(label, key=f"btn_{c}", use_container_width=True):
                    st.session_state.current_class = c
        st.write("")

# åˆå§‹åŒ–é è¨­ç­ç´š (è‹¥æ˜¯é€±äºŒå°±é è¨­ç¾è¡“)
if 'current_class' not in st.session_state:
    st.session_state.current_class = "ç¾è¡“" if weekday == 1 else "è¶³çƒ"

# --- 5. ä¸»ç•«é¢ ---
current_class = st.session_state.current_class
st.title(f"ğŸ {current_class}")

if current_class in st.session_state.done_list:
    st.success("ä»Šæ—¥å·²é»åå®Œæˆ")

st.divider()

# ä¸€éµåˆ°
